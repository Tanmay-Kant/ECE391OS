I've modified small things in the code (a pointer added/removed here, some memory leak on purpose). So don't copy this code or you'll be spending longer debugging than you would've just coding it yourself.
